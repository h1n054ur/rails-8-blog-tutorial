# Routing & ActionController

## Overview

Rails routing connects incoming HTTP requests to controller actions. The router recognizes URLs and dispatches them to appropriate controller methods, while also generating path and URL helpers for your application.

## Basic Routing

### Routes File Structure
```ruby
# config/routes.rb
Rails.application.routes.draw do
  # Root route
  root 'posts#index'
  
  # Basic routes
  get '/about', to: 'pages#about'
  post '/contact', to: 'pages#contact'
  
  # RESTful resources
  resources :posts
  resources :users, except: [:destroy]
  resources :comments, only: [:create, :update, :destroy]
  
  # Nested resources
  resources :posts do
    resources :comments, except: [:index, :show]
  end
  
  # Namespaced routes
  namespace :admin do
    resources :users
    resources :posts
  end
  
  # API routes
  namespace :api do
    namespace :v1 do
      resources :posts, only: [:index, :show]
    end
  end
end
```

### RESTful Routes
```bash
# Generated by resources :posts
GET    /posts          posts#index    (all posts)
GET    /posts/new      posts#new      (new post form)
POST   /posts          posts#create   (create post)
GET    /posts/1        posts#show     (show post)
GET    /posts/1/edit   posts#edit     (edit post form)
PATCH  /posts/1        posts#update   (update post)
DELETE /posts/1        posts#destroy  (delete post)
```

## Advanced Routing

### Custom Routes and Constraints
```ruby
Rails.application.routes.draw do
  # Custom member routes
  resources :posts do
    member do
      patch :publish
      delete :archive
    end
    
    collection do
      get :search
      get :featured
    end
  end
  
  # Route constraints
  get '/posts/:id', to: 'posts#show', constraints: { id: /\d+/ }
  get '/users/:username', to: 'users#show', constraints: { username: /[A-Za-z]+/ }
  
  # Advanced constraints
  constraints subdomain: 'api' do
    namespace :api do
      resources :posts
    end
  end
  
  # Custom constraint classes
  constraints lambda { |req| req.user_agent =~ /iPhone/ } do
    get '/mobile', to: 'mobile#index'
  end
  
  # Route globbing
  get '/pages/*page', to: 'pages#show'
  
  # Optional segments
  get '/posts(/:category)', to: 'posts#index'
  
  # Route redirects
  get '/old-path', to: redirect('/new-path')
  get '/posts/:id', to: redirect('/articles/%{id}')
end
```

### Route Helpers
```ruby
# Path helpers (relative paths)
posts_path                    # => '/posts'
post_path(@post)             # => '/posts/1'
new_post_path                # => '/posts/new'
edit_post_path(@post)        # => '/posts/1/edit'

# URL helpers (absolute URLs)
posts_url                    # => 'http://example.com/posts'
post_url(@post)              # => 'http://example.com/posts/1'

# With parameters
posts_path(category: 'ruby') # => '/posts?category=ruby'
post_path(@post, format: :json) # => '/posts/1.json'

# Nested routes
post_comments_path(@post)    # => '/posts/1/comments'
post_comment_path(@post, @comment) # => '/posts/1/comments/1'
```

## ActionController Basics

### Controller Structure
```ruby
# app/controllers/posts_controller.rb
class PostsController < ApplicationController
  # Callbacks
  before_action :authenticate_user!, except: [:index, :show]
  before_action :set_post, only: [:show, :edit, :update, :destroy]
  before_action :check_owner, only: [:edit, :update, :destroy]
  
  # Actions
  def index
    @posts = Post.published.includes(:user).page(params[:page])
    @featured_posts = Post.featured.limit(5)
  end
  
  def show
    @comment = Comment.new
    respond_to do |format|
      format.html
      format.json { render json: @post }
      format.xml { render xml: @post }
    end
  end
  
  def new
    @post = current_user.posts.build
  end
  
  def create
    @post = current_user.posts.build(post_params)
    
    if @post.save
      redirect_to @post, notice: 'Post was successfully created.'
    else
      render :new, status: :unprocessable_entity
    end
  end
  
  def edit
    # @post set by before_action
  end
  
  def update
    if @post.update(post_params)
      redirect_to @post, notice: 'Post was successfully updated.'
    else
      render :edit, status: :unprocessable_entity
    end
  end
  
  def destroy
    @post.destroy
    redirect_to posts_path, notice: 'Post was successfully deleted.'
  end
  
  private
  
  def set_post
    @post = Post.find(params[:id])
  end
  
  def post_params
    params.require(:post).permit(:title, :content, :published, tag_ids: [])
  end
  
  def check_owner
    redirect_to posts_path, alert: 'Access denied.' unless @post.user == current_user
  end
end
```

### Application Controller
```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  # CSRF protection
  protect_from_forgery with: :exception
  
  # Authentication
  before_action :authenticate_user!
  before_action :configure_permitted_parameters, if: :devise_controller?
  
  # Authorization
  include Pundit::Authorization
  rescue_from Pundit::NotAuthorizedError, with: :access_denied
  
  # Error handling
  rescue_from ActiveRecord::RecordNotFound, with: :not_found
  rescue_from ActionController::ParameterMissing, with: :bad_request
  
  private
  
  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
  helper_method :current_user
  
  def authenticate_user!
    redirect_to login_path, alert: 'Please log in.' unless current_user
  end
  
  def configure_permitted_parameters
    devise_parameter_sanitizer.permit(:sign_up, keys: [:name, :email])
  end
  
  def access_denied
    redirect_to root_path, alert: 'Access denied.'
  end
  
  def not_found
    render file: 'public/404.html', status: :not_found, layout: false
  end
  
  def bad_request
    render json: { error: 'Bad request' }, status: :bad_request
  end
end
```

## Request and Response Handling

### Parameter Handling
```ruby
class PostsController < ApplicationController
  def index
    # Query parameters
    @category = params[:category]
    @page = params[:page] || 1
    @per_page = params[:per_page]&.to_i || 10
    
    # Strong parameters
    if params[:search].present?
      @posts = Post.search(search_params[:query])
    else
      @posts = Post.all
    end
  end
  
  def create
    # Required parameters
    @post = Post.new(post_params)
    
    # Optional parameters
    @post.published = true if params[:publish].present?
  end
  
  private
  
  def post_params
    params.require(:post).permit(:title, :content, :category_id, tag_ids: [])
  end
  
  def search_params
    params.permit(:query, :category, :sort_by, :order)
  end
end
```

### Response Formats
```ruby
class PostsController < ApplicationController
  def show
    @post = Post.find(params[:id])
    
    respond_to do |format|
      format.html # Renders show.html.erb
      format.json { render json: @post.to_json(include: :comments) }
      format.xml { render xml: @post }
      format.pdf { render pdf: "post-#{@post.id}" }
    end
  end
  
  def create
    @post = Post.new(post_params)
    
    if @post.save
      respond_to do |format|
        format.html { redirect_to @post }
        format.json { render json: @post, status: :created }
        format.js   # Renders create.js.erb for AJAX
      end
    else
      respond_to do |format|
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end
end
```

### Rendering Options
```ruby
class PostsController < ApplicationController
  def show
    # Render template
    render 'posts/show'
    render template: 'posts/show'
    
    # Render with layout
    render layout: 'admin'
    render layout: false
    
    # Render JSON
    render json: @post
    render json: @post, status: :created
    render json: { post: @post, comments: @post.comments }
    
    # Render text/plain
    render plain: 'Hello World'
    
    # Render raw content
    render body: 'Raw content', content_type: 'text/plain'
    
    # Render nothing (empty response)
    head :ok
    head :not_found
    head :no_content
  end
  
  def create
    # Redirect
    redirect_to @post
    redirect_to posts_path, notice: 'Success!'
    redirect_to posts_path, alert: 'Error occurred'
    redirect_back(fallback_location: root_path)
    
    # Redirect with status
    redirect_to @post, status: :moved_permanently
  end
end
```

## Filters and Callbacks

### Before/After Actions
```ruby
class PostsController < ApplicationController
  # Before actions
  before_action :authenticate_user!
  before_action :set_post, only: [:show, :edit, :update, :destroy]
  before_action :check_permissions, except: [:index, :show]
  
  # After actions
  after_action :log_action
  after_action :track_view, only: [:show]
  
  # Around actions
  around_action :benchmark_action, only: [:create, :update]
  
  private
  
  def set_post
    @post = Post.find(params[:id])
  rescue ActiveRecord::RecordNotFound
    redirect_to posts_path, alert: 'Post not found'
  end
  
  def check_permissions
    return if current_user&.admin?
    return if @post&.user == current_user
    
    redirect_to posts_path, alert: 'Access denied'
  end
  
  def log_action
    Rails.logger.info "#{current_user&.email} performed #{action_name} on #{controller_name}"
  end
  
  def track_view
    @post.increment!(:views_count) if @post
  end
  
  def benchmark_action
    start_time = Time.current
    yield
    duration = Time.current - start_time
    Rails.logger.info "Action took #{duration.round(3)}s"
  end
end
```

### Skip Callbacks
```ruby
class ApiController < ApplicationController
  skip_before_action :verify_authenticity_token # For API endpoints
  skip_before_action :authenticate_user!, only: [:index, :show]
  
  # Conditional skipping
  skip_before_action :set_locale, if: :api_request?
  
  private
  
  def api_request?
    request.format.json?
  end
end
```

## Sessions and Cookies

### Session Management
```ruby
class SessionsController < ApplicationController
  def create
    user = User.authenticate(params[:email], params[:password])
    
    if user
      session[:user_id] = user.id
      session[:login_time] = Time.current
      redirect_to dashboard_path
    else
      flash.now[:alert] = 'Invalid credentials'
      render :new
    end
  end
  
  def destroy
    session.delete(:user_id)
    redirect_to root_path, notice: 'Logged out successfully'
  end
  
  def current_user
    @current_user ||= User.find(session[:user_id]) if session[:user_id]
  end
end
```

### Cookie Handling
```ruby
class PreferencesController < ApplicationController
  def update
    # Set regular cookie
    cookies[:theme] = params[:theme]
    
    # Set encrypted cookie
    cookies.encrypted[:user_preferences] = {
      theme: params[:theme],
      language: params[:language]
    }
    
    # Set signed cookie
    cookies.signed[:user_id] = current_user.id
    
    # Set cookie with options
    cookies[:remember_token] = {
      value: SecureRandom.hex(20),
      expires: 1.month.from_now,
      httponly: true,
      secure: Rails.env.production?
    }
  end
  
  def show
    @theme = cookies[:theme] || 'light'
    @preferences = cookies.encrypted[:user_preferences] || {}
  end
end
```

## HTTP Status Codes and Error Handling

### Common Status Codes
```ruby
class PostsController < ApplicationController
  def show
    if @post
      render :show # 200 OK (default)
    else
      render :not_found, status: :not_found # 404
    end
  end
  
  def create
    if @post.save
      render json: @post, status: :created # 201
    else
      render json: @post.errors, status: :unprocessable_entity # 422
    end
  end
  
  def update
    if authorized?
      # Update logic
      head :no_content # 204
    else
      head :forbidden # 403
    end
  end
  
  def destroy
    if @post.destroy
      head :no_content # 204
    else
      render json: { error: 'Cannot delete' }, status: :conflict # 409
    end
  end
end
```

### Global Error Handling
```ruby
class ApplicationController < ActionController::Base
  rescue_from ActiveRecord::RecordNotFound, with: :not_found
  rescue_from ActionController::ParameterMissing, with: :bad_request
  rescue_from Pundit::NotAuthorizedError, with: :forbidden
  rescue_from StandardError, with: :internal_server_error
  
  private
  
  def not_found(exception)
    respond_to do |format|
      format.html { render 'errors/404', status: :not_found }
      format.json { render json: { error: 'Not found' }, status: :not_found }
    end
  end
  
  def bad_request(exception)
    render json: { error: exception.message }, status: :bad_request
  end
  
  def forbidden(exception)
    render json: { error: 'Access denied' }, status: :forbidden
  end
  
  def internal_server_error(exception)
    Rails.logger.error exception
    render json: { error: 'Internal server error' }, status: :internal_server_error
  end
end
```

## Testing Controllers

### Controller Tests
```ruby
# test/controllers/posts_controller_test.rb
class PostsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:one)
    @post = posts(:one)
    sign_in @user
  end
  
  test "should get index" do
    get posts_path
    assert_response :success
    assert_select 'h1', 'Posts'
  end
  
  test "should create post" do
    assert_difference('Post.count') do
      post posts_path, params: { 
        post: { title: 'New Post', content: 'Content' } 
      }
    end
    assert_redirected_to post_path(Post.last)
  end
  
  test "should update post" do
    patch post_path(@post), params: { 
      post: { title: 'Updated Title' } 
    }
    assert_redirected_to post_path(@post)
    assert_equal 'Updated Title', @post.reload.title
  end
  
  test "should require authentication" do
    sign_out @user
    get new_post_path
    assert_redirected_to login_path
  end
end
```

## References

- [Rails Routing](https://guides.rubyonrails.org/routing.html)
- [Action Controller Overview](https://guides.rubyonrails.org/action_controller_overview.html)
- [Rails Testing Guide](https://guides.rubyonrails.org/testing.html)
- [Layouts and Rendering](https://guides.rubyonrails.org/layouts_and_rendering.html)